name: Build Setup

on:
  workflow_dispatch:
  push:
    branches:
      - ci-setup
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Встановлюємо vswhere для пошуку шляхів
      - name: Install vswhere
        run: choco install vswhere -y

      # Знаходимо VS Developer Command Prompt і devenv.com
      - name: Setup Visual Studio paths
        run: |
          $vsPath = vswhere -latest -products * -property installationPath
          $vsDevCmd = Join-Path $vsPath "Common7\Tools\vsdevcmd.bat"
          $devenvPath = Join-Path $vsPath "Common7\IDE\devenv.com"
          echo "VSDEVCMD=$vsDevCmd" >> $env:GITHUB_ENV
          echo "DEVENV_PATH=$devenvPath" >> $env:GITHUB_ENV

      - name: Restore NuGet packages
        run: nuget restore VideoServer/VideoServer.sln

      - name: Setup VS environment
        shell: cmd
        run: |
          call "%VSDEVCMD%" -arch=amd64

      - name: Fix VDPROJ Build Error (HRESULT 8000000A)
        shell: pwsh
        run: |
          # Find the Visual Studio installation path
          $vsPath = & vswhere -latest -property installationPath

          # Path to the fix utility
          $fixExe = Join-Path $vsPath "Common7\IDE\CommonExtensions\Microsoft\VSI\DisableOutOfProcBuild\DisableOutOfProcBuild.exe"
          
          if (Test-Path $fixExe) {
            Write-Host "Running DisableOutOfProcBuild.exe..."
            Start-Process -FilePath $fixExe -Wait
          } else {
            Write-Error "Fix utility not found at $fixExe"
          }

      - name: Build Setup project (.vdproj)
        shell: cmd
        continue-on-error: true
        run: |
          "%DEVENV_PATH%" "VideoServer/VideoServer.sln" /build "Release|x64" /project "Setup"


      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            **/Release/Setup.msi
            **/Release/setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN}}
